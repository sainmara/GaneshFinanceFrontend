<html>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <head>

        <!-- sweetalerts js files-->
        <!-- Include SweetAlert CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.0/dist/sweetalert2.min.css">

        <!-- Include SweetAlert JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.0/dist/sweetalert2.min.js"></script>
        


        <link rel="stylesheet" href="project-finance.css"/>
        <script src="project-finence.js"></script>

        <style>

            
.labelApplyLoan {
  color: #b4886b;
  margin-left: 24px;
  margin-right: 4px;
  font-weight: bold;
  width: 200px;
  float: left;
}

table {
    border-collapse: collapse;
}

td {
    padding-top: .5em;
    padding-bottom: .5em;
}


#applyLoanTable {
        width: 40%;
        margin-left: 30%;
        margin-right: 30%;
        margin-top: 100px;

      }

.swal-wide {
        width: 95vw;
      }

.inputApplyLoan {
  margin-bottom: 12px;
  height: 12px;
  width: 300px;
}

      #transactionTableTitle{
        font-size: 24px;
        font-weight: bold;
        font-family: sans-serif;
        color:#7d7d7d;
      }

            .heading{
                display :flex;
                justify-content: space-between;
                padding:5px ;
                box-sizing: border-box;
                background-color: orange;
            }
            .tdata
            {
                cursor: pointer;
            }
            
            .logoutbtn
            {
                color:white; 
                background-color: black;
            }
            .logoutbtn:hover{
                color: orange;
            }
            /* Dialog box css start */
            .basebtn
            {
                color:white;    
                background-color: orange;
            }
            .rejectbtn
            {
                color:white;
                background-color: black;
            }
            .rejectbtn:hover{
                color:orange;
                
            }
            .btnArea
            {
               display: flex;
               justify-content: center;
               gap: 10px;
            }
            .closeBtn
            {
                display: flex;
                justify-content: flex-end;
            }
            /* Dialog box css end */

            
            /* Used for highlighting the selected row in table */
            .active
            {
                background-color: orange;
            }

            /* Error message css when manager enters higher sanction amount then requesteamount */
            #errmsgSAmount,#errmsgDAmount
            {
                color:red;
            }


        </style>
        <script>
            
        </script>
    </head>
    <body>
        <div class="heading">
            <span id="uname"></span>
            
            
            <div class="options">
                <span><a href="#" onclick="showme('home')">Home</a></span>
                <!-- <span><a href="#emicalculator" onclick="showme('emicalc')">EMI Calculator</a></span> -->
                <span><a href="#" onclick="showme('loanapplications')">Applications</a></span>
                <span><a href="#" onclick="showme('loanaccount')"">Active Loans</a></span>
                  <!-- <button
                  type="button"
                  class="btn"
                  id="apply"
                  onclick="showme('applyLoanDialog')"
                 
                  >
                  Apply New Loan
                </button> -->
                <button type="button" class="btn logoutbtn" id="apply"  onclick="logout()">Logout</button>
              </div>
        </div>
        <br>
        <div id="home"> Home</div>
        <div id="loanapplications">
            <div class="optionsArea">
                <div>
                <label for="loanType" class="form-label">Loan Type</label>
                <select id="loanType" onchange="updateTable()" >
                    <option value="0" selected>ALL</option>
                    <option value="1">Home Loan</option>
                    <option value="2">Education Loan</option>
                    <option value="3">Gold Loan</option>
                </select>
            </div>
                <div class="dateSelect">
                    <div>
                    <label for="fromdate" class="form-label">From Date</label>
                    <input type="date"  id="fromdate" onchange="updateTableDate()">
                    </div>
                    <div>
                    <label for="todate" class="form-label">To Date</label>
                    <input type="date"  id="todate" onchange="updateTableDate()" >
                    </div>
                </div>
                <div>
                    <label for="loanStatus" class="form-label">Loan Status</label>
                    <select id="loanStatus" onchange="updateTableStatus()" >
                        <option value="4" selected>ALL</option>
                        <option value="0">Pending</option>
                        <option value="1">Approved</option>

                        <option value="2">Rejected</option>
                        <option value="3">Cancelled</option>
                        
                    </select>
                </div>

            </div>
            
            <div>
                <table class="table table-bordered">
                    <tr>
                        <th>Loan Application Number</th>
                        <th>Loan Amount</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Status</th>
                       
                    </tr>
                    <tbody id="tabdata">

                    </tbody>
                </table>

            </div>
        </div>
        <div id="loanaccount">
            Loan Account
            
      
            <div>
              <select id="loanType2" onchange="updateLoanAccountTable()">

                <option value="0" selected>ALL</option>
                <option value="1">Home Loan</option>
                <option value="2">Education Loan</option>
                <option value="3">Gold Loan</option>
              </select>
            </div>
            
            <div>
                <table class="table table-bordered">
                    <tr>
                      <th>Loan Account Number</th>
                      <th>Loan Sacntioned Amount</th>
                      <th>Loan Disbursed Amount</th>
                      <th>Approval Date</th>
                      <th>Intrest rate</th>
                      <th>EMI</th>
                      <th>Status</th>
                    </tr>
                    <tbody id="loanaccountdata"></tbody>
                  </table>
            </div>
          </div>
        <dialog id="Dialog1">

        </dialog>
    </body>
    <script>
        if(localStorage.getItem("userDetails")!= null)
        {
        var  localstorageData= JSON.parse(localStorage.getItem("userDetails"));
        if(localstorageData["role"] ==0){

        document.getElementById("uname").innerHTML=`${localstorageData["username"]}`;
        

        let user = JSON.parse(localStorage.getItem("userDetails"));
        let branchcode =user.branchCode ;
        let xmlhttp = new XMLHttpRequest();
        let url =`http://localhost:8080/loanApplication/branch/${branchcode}`;
        xmlhttp.open("GET",url);
        xmlhttp.send();
        xmlhttp.onload=function()
        {
           let data=JSON.parse(xmlhttp.responseText);
           showData(data);
        }
        
            function updateTable()
            {

                let optionSelected=document.getElementById("loanType").value;
                if (optionSelected == 0) {

                var url = `http://localhost:8080/loanApplication/branch/${branchcode}`;
                } else {
                url = `http://localhost:8080/loanApplication/branch/${branchcode}`;

                }
                xmlhttp.open("GET",url);
                xmlhttp.send();
                xmlhttp.onload=function()
                {
                    let tableData=JSON.parse(xmlhttp.responseText);
                    if(optionSelected !=0 ){
                    tableData = tableData.filter(function(t){ return t.loan_type ==optionSelected ;});
                    }
                    showData(tableData);

                    
                }
            }
            function updateTableStatus()
            {
                let optionSelected=document.getElementById("loanStatus").value;
                var url= `http://localhost:8080/loanApplication/branch/${branchcode}`;
                xmlhttp.open("GET",url);
                xmlhttp.send();
                xmlhttp.onload=function()
                {
                    let tableData=JSON.parse(xmlhttp.responseText);
                    let tdata=tableData;
                    if(optionSelected!=4){
                             tdata=tableData.filter(function(t){return t.application_status == optionSelected});
                            }
                    console.log(tdata);
                    showData(tdata);                 
                }

            }
            function updateTableDate()
            {
                let fromdate=document.getElementById("fromdate");
                let todate=document.getElementById("todate");
                let currentDate = new Date().toJSON().slice(0, 10);

                if(todate.value>currentDate ){
                  Swal.fire({title:"Date cannot be more than current date"});
                  todate.value=currentDate;
                }
                if(fromdate.value>currentDate ){
                  Swal.fire({title:"Date cannot be more than current date"});
                  fromdate.value=currentDate;
                }

                let user = JSON.parse(localStorage.getItem("userDetails"));
                let branchcode =user.branchCode ;

                if(fromdate.value < todate.value)
                {   
                    if(fromdate.value && todate.value)
                    {
                        
                        // var url=`http://localhost:8080/loanApplication/date/${fromdate.value}/${todate.value}`;
                        // xmlhttp.open("GET",url);
                        // xmlhttp.send();
                        // xmlhttp.onload=function()
                        // {
                        //     let tableData=JSON.parse(xmlhttp.responseText);
                        //     let tdata=tableData;
                        //     //console.log(tdata);
                        //     showData(tdata);  
                        // }
                        var url= `http://localhost:8080/loanApplication/branch/${branchcode}`;
                        xmlhttp.open("GET",url);
                        xmlhttp.send();
                        xmlhttp.onload=function()
                        {
                            let tableData=JSON.parse(xmlhttp.responseText);
                            let tdata=tableData.filter(function(t){return t.application_date >= fromdate.value && t.application_date<=todate.value});
                            
                            
                            showData(tdata,"tabdata");  
                        }
                    } 

                }
                else{
                    if(todate.value){
                        fromdate.value=todate.value;
                        var url= `http://localhost:8080/loanApplication/branch/${branchcode}`;
                        xmlhttp.open("GET",url);
                        xmlhttp.send();
                        xmlhttp.onload=function()
                        {
                            let tableData=JSON.parse(xmlhttp.responseText);
                            let tdata=tableData.filter(function(t){return t.application_date >= fromdate.value && t.application_date<=todate.value});
                            
                            
                            showData(tdata,"tabdata");  
                        }
                    }
                }

                
            }
            
            function showData(data)
            {
                var t=document.getElementById("tabdata");
                t.innerHTML="";
                for(var i=0;i<data.length;i++){
                let status="";
                switch(data[i].application_status)
                {
                    case 0: status="Pending";break;
                    case 1: status="Approved";break;
                    case 2: status="Rejected";break;
                    case 3: status="Cancelled";break;
                    case 4: status="Topup Pending";break;
                }
               
                    let type="";
                    switch(data[i].loan_type)
                    {
                        case 3: type="Gold Loan";break;
                        case 1: type="HomeLoan";break;
                        case 2: type="Education Loan";break;
                        
                    }
                   
                   var ele=`<tr id=${data[i].loan_application_number} class="tdata" onclick="openDialogLoanApp('${data[i].loan_application_number}','${data[i].loan_application_number}')"><td> ${data[i].loan_application_number}</td><td> ${data[i].requested_amount}</td><td> ${data[i].application_date}</td> <td> ${type}</td><td> ${status}</td></tr> `;
                    
                    t.innerHTML+=ele;
                   
                
            }
            }
        }
        else{
            window.location.assign(localstorageData["role"] == 1?"clerk.html":"customer.html");
        }
        }
        else{
            window.location.assign("login.html");
        }
            //{applicationnumber,clerkId,csutomerId,loanType,applicationStatus,loanTenure,applicationDate,roi,requestedAmount}
        function openDialogLoanApp(applicationNumber,trid)
        {  
            //Code for highlighting the table selected row 
            var st=" ";
            st+=trid;

            const element = document.getElementById(trid);
            element.classList.add('active');
            const siblings = Array.from(element.parentNode.children);
            siblings.forEach(sibling => {
            if (sibling !== element) {
                sibling.classList.remove('active');
            }
            });

            // 

            let xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET",`http://localhost:8080/loanApplication/number/${applicationNumber}`);
            xmlhttp.send();
            xmlhttp.onload=function()
            {
                let applicationData= JSON.parse(xmlhttp.responseText);

                let dialog=document.getElementById("Dialog1");
            dialog.innerHTML=`
            <div class="closeBtn">
            <button  type="button" class="btn-close" aria-label="Close" onclick="closeDialog('${st}')"></button>
            </div>
            <table class="table table-bordered" >
                <thead>
                <tr>
                <th>Loan Aplication Number</th>
                <th>Customer ID</th>
                <th>Requested Amount</th>
                <th>Application Date</th>
                <th>Loan Tenure</th>
                <th>ROI</th>
                
                </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${applicationData.loan_application_number}</td>
                        <td>${applicationData.customer_id}</td>
                        <td>${applicationData.requested_amount}</td>    
                        <td>${applicationData.application_date}</td>
                        <td>${applicationData.loan_tenure}</td>
                        <td>${applicationData.roi}</td>
                        
                    </tr>
                </tbody>
            </table>
           
            
            `;
            if(applicationData.application_status == 0)
            {
                
                dialog.innerHTML+=`
                 
                <div>
                        <label for="sanctionedamount" class="form-label">Sanctioned Amount</label>
                        <input type="number" id="sanctionedamount" value="0" required>
                        <span id="errmsgSAmount"></span>
                </div>
                
                <div>
                        <label for="disbursedamount" class="form-label">Disbursed Amount</label>
                        <input type="number" id="disbursedamount" value="0" required>
                        <span id="errmsgDAmount"></span>
                </div>
                <div class="btnArea" id="btnArea">
                <button type="button" class="btn  basebtn" onclick="approveAlert(1,'${applicationData.loan_application_number}')">Approve</button>
                <button type="button" class="btn  rejectbtn" onclick="approveAlert(0,'${applicationData.loan_application_number}')">Reject</button>
            </div>`;
            }
           
            dialog.open=true;
            }
              
        }
        function ApprovalRequest(role,approvalCode,customerID,managerId,loan_application_number,loan_type,loanStatus,loan_tenure,disbursedAmount,sanctionedAmount,emi,roi)
        {

            this.role=role;
            this.approvalCode=approvalCode;
            this.loan_application_number=loan_application_number;
            this.customer_id=customerID;
            this.manager_id=managerId;
            this.loan_type_code=loan_type;
            this.disbursed_amount=disbursedAmount;
            this.sanctioned_amount=sanctionedAmount;
            this.emi=emi;
            this.loan_status=loanStatus;
            this.loan_tenure=loan_tenure;
            this.roi=roi;
        }
        function approveAlert(code,applicationNumber)
        {
            /*testing swal then function*/
            let text="";
            if(code ==1)
            {
                text="Approve";
            }
            else{
                text="Reject";
            }
            Swal.fire({
                title:`Confirm ${text}?`,
                text: "",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${text} it!`,
                cancelButtonText: 'No, cancel!',
            
                }).then((result) => {
                if (result.isConfirmed) {
                    if(code== 1)
                    {
                        console.log(code);
                        approveLoan(applicationNumber);
                        
                    }else{
                     rejectLoan(applicationNumber);
                     
                    }
                } else if (
                    /* Read more about handling dismissals below */
                    result.dismiss === Swal.DismissReason.cancel
                ) {
                    console.log("Cancceled");
                }
                })
            }
            function approveLoan(applicationNumber){
            //setting the errormessages empty
            document.getElementById("errmsgSAmount").innerHTML="";
            document.getElementById("errmsgDAmount").innerHTML="";

            let xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET",`http://localhost:8080/loanApplication/number/${applicationNumber}`);
            xmlhttp.send();
            xmlhttp.onload=function()
            {
              

                let applicationData= JSON.parse(xmlhttp.responseText);
                let storedData=JSON.parse(localStorage.getItem("userDetails"));
                console.log(applicationData);
                let sanctionedAmount=document.getElementById("sanctionedamount").value;
                let disbursedAmount=document.getElementById("disbursedamount").value;
                if(sanctionedAmount>applicationData.requested_amount)
                {
                    document.getElementById("errmsgSAmount").innerHTML="Please Enter Valid Amount";
                    document.getElementById("sanctionedamount").value='';
                }
                else{
                    
                    if(disbursedAmount>sanctionedAmount)
                    {
                        document.getElementById("errmsgDAmount").innerHTML="Please Enter Valid Amount";
                        document.getElementById("disbursedamount").value='';
                    }
                    else{
                        // adding all loan details as object
                        let loan_application_number=applicationData.loan_application_number;
                        let role=storedData.role;
                        let approvalCode="1";
                        let customerID=applicationData.customer_id;
                        let managerId=storedData.id;
                        let loan_type=applicationData.loan_type;
                        console.log(managerId);

                        let loanStatus="1";
                        let loan_tenure=applicationData.loan_tenure;
                        let roi=applicationData.roi;
                    
                        
                        
                        
                        rate = (roi)/12/100; // loan rate per year / 100 = loan percentage

                        let emi = ((sanctionedAmount * rate * (1+rate)**loan_tenure)/(((1+rate)**loan_tenure)-1));


                        


                        // packing the data into approvalrequest object..
                        let sendingData=new ApprovalRequest(role,approvalCode,customerID,managerId,loan_application_number,loan_type,loanStatus,loan_tenure,disbursedAmount,sanctionedAmount,emi,roi);
                        
                        //commented the code becasue no need to approve all the loans because checking other functonaloties related to dialog box

                        xmlhttp.open("POST","http://localhost:8080/loanApplication/approve");
                        xmlhttp.setRequestHeader("content-type","application/json")
                        console.log(sendingData);
                        xmlhttp.send(JSON.stringify(sendingData));
                        xmlhttp.onload=function()
                        {
                            console.log(JSON.stringify(xmlhttp.responseText));
                            document.getElementById("btnArea").style.display="none";
                        }
                        
                    }
                }
            }
        }
        function rejectLoan(applicationNumber)
        {
                let storedData=JSON.parse(localStorage.getItem("userDetails"));
                let loan_application_number=applicationNumber;
                let role=storedData.role;
                let approvalCode="0";
                let customerID=null;
                let managerId=storedData.id;
                let loan_type=null;
                let disbursedAmount=0;
                let sanctionedAmount=0;
                let emi=0
                let loanStatus="0";
                let loan_tenure=null;
                let roi=null;


                // packing the data into approvalrequest object..
                let sendingData=new ApprovalRequest(role,approvalCode,customerID,managerId,loan_application_number,loan_type,loanStatus,loan_tenure,disbursedAmount,sanctionedAmount,emi,roi);
                let xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST","http://localhost:8080/loanApplication/approve");
                xmlhttp.setRequestHeader("content-type","application/json")
                xmlhttp.send(JSON.stringify(sendingData));
                xmlhttp.onload=function()
                {
                    console.log(JSON.stringify(xmlhttp.responseText));
                    document.getElementById("btnArea").style.display="none";
                }

//            }
        }


        function closeDialog(trid)
        {
            const element = document.getElementById(trid.slice(1));
            element.classList.remove('active');
            document.getElementById("Dialog1").open=false;
        }
        function logout()
        {
                localStorage.removeItem("userDetails");
                window.location.assign("ganesh-finance.html");
        }



        var navbarids=["loanapplications","loanaccount","home"]
    // function for nav bar to nacigate between multiple tabs in navbar
    function showme(id)
    { 
            navbarids.forEach(ele =>
            {
            if(ele != id)
            {
                document.getElementById(ele).style.display="none";
            }
            });
            
        
            document.getElementById(id).style.display="block";

    }


    // getting detals from localstorafe

        function loanAccountRequest(role,branch_code,id)
        {
          this.role = role;
          this.branch_code = branch_code;
          this.id = id;
        }

        let user =JSON.parse(localStorage.getItem("userDetails"));

        let branch_code =user.branchCode ;
        let id=user.id;
        let role=user.role;
        let xmlhttp1=new XMLHttpRequest();
        // let xmlhttp = new XMLHttpRequest();
        url =`http://localhost:8080/loanAccount`;
        xmlhttp1.open("POST", url);
        let data = JSON.stringify( new loanAccountRequest(role,branch_code,id));
        xmlhttp1.setRequestHeader("content-type", "application/json");
        console.log(data);
        xmlhttp1.send(data);
            
      
        xmlhttp1.onload = function () {
          let data=JSON.parse(xmlhttp1.responseText);

          console.log(data);
          let tbodyloanAccount = document.getElementById("loanaccountdata");
          tbodyloanAccount.innerHTML="";
          for (var i = 0; i < data.length; i++) {


            let status = "";
        switch (data[i].loan_status) {
          case 0:
            status = "Pending";
            break;
          case 1:
            status = "Approved";
            break;
          case 2:
            status = "Rejected";
            break;
          case 3:
            status = "Cancelled";
            break;
          case 4:
            status = "Topup Pending";
            break;
        }
        console.log("ok");
          var ele = `<tr id=${data[i].loan_account_number} onclick=showLoanDetails('${data[i].loan_account_number}')><td>${data[i].loan_account_number}</td><td> ${data[i].sanctioned_amount}</td><td> ${data[i].disbursed_amount}</td><td> ${data[i].approval_date}</td> <td> ${data[i].roi}</td><td> ${data[i].emi}</td><td>${status}</td></tr> `;
          
            tbodyloanAccount.innerHTML+=ele;

          }
        };
        
        
</script>
</html>