<html>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="project-finance.css"/>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
  <head>
    <style>
      .applyLoanTable {
        width: 300px;
      }
      #loanapplications
      {
        display: none;
      }
      #loanaccount
      {
        display: none;
      }
      
      /* dialog box css start */

      #applyLoanDialog
      {
        margin: auto;
        display: none;
      }
      
      /* end of dialog box cs */

      /* emicalculator css strat */
              *{
                    padding: 0;
                    margin: 0;
                    box-sizing: border-box;
                }
                #emicalc
                {
                  display: none;
                }
                .main{
                    width: 540px;
                    background: #ffffff;
                    padding: 20px 25px;
                    border-radius: 10px;
                    box-shadow: 0 0 60px rgba(1, 0, 5, 0.15);
                  

                }

                .main h2{
                    font-size: 28px;
                    font-weight: 700;
                }

                

                .main .calculator{
                    position: relative;
                    flex-direction: row;
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: space-around;
                    padding: 10px 0px;
                }


                .calculator .calculator-input{
                    position: relative;
                    width: 50%;
                    justify-content: space-around;
                    padding: 5px 10px;
                    display: block;
                }

                .calculator .calculator-input input{
                    width: 100%;
                    height: 40px;
                    padding: 20px 14px;
                    font-family: "Poppins",sans-serif;
                    font-weight: 400;
                    font-size: 18px;
                    border: 1px solid #7d7d7d;
                    border-radius: 4px;
                }

                .calculator .calculator-input input:focus{
                    outline: none;
                    border: 1px solid #f4511e;
                }


                .calculator .calculator-input label{
                    color:#f4511e;
                    font-size: 16px;
                    padding: 2px 4px;
                    font-weight: 500;
                }

                .calculator .calculator-input button {
                    width: 100%;
                    padding: 14px 16px;
                    margin-top: 20px;
                    font-weight: 700;
                    cursor: pointer;
                    background: orange;
                    border: 0;
                    color: #FFFFFF;
                    font-size: 14px;
                    text-transform: uppercase;
                    border-radius: 4px;
                }
                .main .calculator-result{
                    position: relative;
                    display: block;
                    padding: 10px;
                    margin: 20px 0;
                }
                .main .calculator-result ul{
                    width: 100%;
                    background: #ff6f43;
                    padding: 10px 15px;
                    border-radius: 5px;
                }

                .main .calculator-result li{
                    list-style: none;
                    line-height: 28px;
                    font-weight: 500;
                    font-size: 18px;
                }


                .calculator-result .loan_emi,
                .calculator-result .loan_principle,
                .calculator-result .loan_interest_rate,
                .calculator-result .loan_total{
                    color: #333332;
                    font-weight: 700;
                    font-size: 22px;
                }

                .calculator-result canvas{
                    padding: 20px;
                }
                /* end of emicalc css */

                /* home page css*/
                #home
                {
                  /* display: none; */
                }
    </style>
    <script>
     
    </script>
  </head>
  <body>
    <div class="heading">
      <span class="title">Ganesh Finance</span>
      <span id="uname"></span>
      <div class="options">
        <span><a href="#" onclick="showme('home')">Home</a></span>
        <span><a href="#emicalculator" onclick="showme('emicalc')">EMI Calculator</a></span>
        <span><a href="#" onclick="showme('loanapplications')">Loan Applications</a></span>
        <span><a href="#" onclick="showme('loanaccount')"">Loan Account</a></span>
          <button
          type="button"
          class="btn"
          id="apply"
          onclick="showme('applyLoanDialog')"
         
          >
          Apply New Loan
        </button>
        <button type="button" class="btn logoutbtn" id="apply"  onclick="logout()">Logout</button>
      </div>
    </div>
    <div id="home"> Home</div>
    <div id="loanapplications">
      <div>
        <select id="loanType" onchange="updateTable()">
          <option value="0" selected>ALL</option>
          <option value="1">Home Loan</option>
          <option value="2">Education Loan</option>
          <option value="3">Gold Loan</option>
        </select>
      </div>
      
      <div>
        <table class="table table-bordered">
          <tr>
            <th>Loan Application Number</th>
            <th>Loan Ammount</th>
            <th>Date</th>
            <th>Type</th>
            <th>Status</th>
            <th>Cancel</th>
          </tr>
          <tbody id="tabdata"></tbody>
        </table>
      </div>
    </div>
    <div id="loanaccount">
      Loan Account
    </div>


    <!-- dialog box for apply-->
    <div id="applyLoanDialog">
      <div class="applyLoanClass">
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          onclick="closeDialog()"
        ></button>
        <table id="applyLoanTable">
          <tbody id="applyLoanForm"></tbody>
          <tr>
            <td>Customer Id:</td>
            <td>
              <input type="text" id="inputCustomerId" readonly required />
            </td>
          </tr>
          
          <tr>
            <td>Loan Type:</td>
            <td>
              <select id="inputLoanType">
                <option value="1">Home Loan</option>
                <option value="2">Education Loan</option>
                <option value="3">Gold Loan</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Loan Tenure:</td>
            <td>
              <input type="number" id="inputLoanTenure" required />
            </td>
          </tr>
          <tr>
            <td>Rate of Interest:</td>
            <td>
              <input type="number" id="inputRoi" required />
            </td>
          </tr>
          <tr>
            <td>Requested Amount:</td>
            <td>
              <input type="text" id="inputRequestedAmount" required />
            </td>
          </tr>
          <tr>
            <td></td>
            <td>
              <input
                type="button"
                id="buttonApplyLoan"
                onclick="applyLoan()"
                value="Apply"
              />
            </td>
          </tr>
        </table>
      </div>
    </div>
    <!-- dialog for apply loan end-->
    <!-- emi calculator part start -->
    
      <div class="main" id="emicalc">
            
        <h2>EMI Calculator</h2>
        
        <div class="calculator">
            <div class="calculator-input">
                <label for="">Loan Amount (Rs.):</label>
                <input type="number" id="loan_amount">
            </div>
            <div class="calculator-input">
                <label for="">Loan Tenure (Year.):</label>
                <input type="number" id="loan_tenure">
            </div>
            <div class="calculator-input">
                <label for="">Interest Rate (%):</label>
                <input type="number" id="loan_interest">
            </div>
            <div class="calculator-input">
                <button class="calculator-btn">Calculate EMI</button>
            </div>
        </div>

        <div class="calculator-result">
            <!---Canvas-->
            <canvas id="loanChart"></canvas>
            <ul>
                <li>Monthly Loan EMI: <span class="loan_emi"></span></li>
                <li>Principle Amount: <span class="loan_principle"></span></li>
                <li>Loan on Interest: <span class="loan_interest_rate"></span></li>
                <li>Total Amount to be paid: <span class="loan_total"></span></li>
            </ul>
        </div>
    
    </div>
  </body>
  <script>
    if (localStorage.getItem("userDetails") != null) {
      var localstorageData = JSON.parse(localStorage.getItem("userDetails"));
      document.getElementById(
        "uname"
      ).innerHTML = `${localstorageData["username"]}`;
    }

    function applyLoanDialog() {
     
      let user = JSON.parse(localStorage.getItem("userDetails"));
      
      document.getElementById("inputCustomerId").value = user.id;
    }

    function applyLoan() {
      //       {
      //     "clerk_id": null,
      //     "customer_id": "1e4b832a-5ec2-11ee-8c99-0242ac120002",
      //     "loan_type": 1,
      //     "application_status": 0,
      //     "loan_tenure": 18,
      //     "roi": 8.7,
      //     "requested_amount": 200000.0
      // }

      function applyLoanRequest(
        
        customer_id,
        loan_type,
        application_status,
        loan_tenure,
        roi,
        requested_amount
      ) {
        this.customer_id = customer_id;
        this.loan_type = loan_type;
        this.application_status = application_status;
        this.loan_tenure = loan_tenure;
        this.roi = roi;
        this.requested_amount = requested_amount;
      }

      let request = JSON.stringify(
        new applyLoanRequest(
          document.getElementById("inputCustomerId").value,
          document.getElementById("inputLoanType").value,
          0,
          document.getElementById("inputLoanTenure").value,
          document.getElementById("inputRoi").value,
          document.getElementById("inputRequestedAmount").value
        )
      );
      console.log(request);
      let xmlhttp = new XMLHttpRequest();
      let url = "http://localhost:8080/loanApplication/apply";
      xmlhttp.open("POST", url);
      xmlhttp.setRequestHeader("content-type", "application/json");
      xmlhttp.send(request);
      xmlhttp.onload = function () {
        let responseText = xmlhttp.responseText;
        console.log(JSON.parse(responseText));
      };

    }// close applyloan method
    let user = JSON.parse(localStorage.getItem("userDetails"));
      let customer_id =user.id ;
    let xmlhttp = new XMLHttpRequest();
    let url =`http://localhost:8080/loanApplication/customer/${customer_id}`;
    xmlhttp.open("GET", url);
    xmlhttp.send();
    xmlhttp.onload = function () {
      let data = JSON.parse(xmlhttp.responseText);
      showData(data);
    };
    function closeDialog(dialog) {
      document.getElementById("applyLoanDialog").style.display = "none";
    }
    function updateTable() {
      let user = JSON.parse(localStorage.getItem("userDetails"));
      let branchcode =user.branchCode ;
      let optionSelected = document.getElementById("loanType").value;
      if (optionSelected == 0) {

        var url = `http://localhost:8080/loanApplication/customer/${customer_id}`;
      } else {
        url = `http://localhost:8080/loanApplication/type/${optionSelected}`;
      }
      xmlhttp.open("GET", url);
      xmlhttp.send();
      xmlhttp.onload = function () {
        let tableData = JSON.parse(xmlhttp.responseText);
        console.log(tableData);
        showData(tableData);
      };
    }



    function showData(data) {
      var t = document.getElementById("tabdata");
      t.innerHTML = "";
      for (var i = 0; i < data.length; i++) {
        let status = "";
        switch (data[i].application_status) {
          case 0:
            status = "Pending";
            break;
          case 1:
            status = "Approved";
            break;
          case 2:
            status = "Rejected";
            break;
          case 3:
            status = "Cancelled";
            break;
          case 4:
            status = "Topup Pending";
            break;
        }

        let type = "";
        switch (data[i].loan_type) {
          case 3:
            type = "Gold Loan";
            break;
          case 1:
            type = "HomeLoan";
            break;
          case 2:
            type = "Education Loan";
            break;
        }

        var ele = `<tr id=${data[i].loan_application_number}><td> ${data[i].loan_application_number}</td><td> ${data[i].requested_amount}</td><td> ${data[i].application_date}</td> <td> ${type}</td><td> ${status}</td> `;
        if (!data[i].application_status) {
          ele += ` <td> <button type="button" class="btn btn-primary" id="apply"  onclick="cancelLoan('${data[i].loan_application_number}',${localstorageData["role"]},'${localstorageData["id"]}')">Cancel Loan</button> </td></tr>`;
        } else if(data[i].application_status== 3)  {
          ele += `<td>Cancelled</td></tr>`;
        }
        else{
          ele += `<td>Cannot cancel</td></tr>`;
        }
        t.innerHTML += ele;
      }
    }
    var navbarids=["loanapplications","loanaccount","emicalc","home","applyLoanDialog"]
    // function for nav bar to nacigate between multiple tabs in navbar
    function showme(id)
    { 
      if(id == "applyLoanDialog")
      {
        applyLoanDialog();
      }

        navbarids.forEach(ele =>
        {
          if(ele != id)
          {
            document.getElementById(ele).style.display="none";
          }
        });
        document.getElementById(id).style.display="block";
          


    }

    /* Cancel loan part*/

    function cancelLoanDetails(role,id,loan_application_number)
    {
      this.loan_application_id = loan_application_number;
      this.role=role;
      this.id=id;
    }
    function cancelLoan(applicationnumber, role, id) {
        
        
        let sendingData = new cancelLoanDetails(role,id,applicationnumber);
        //console.log(sendingData);
        let xmlhttp = new XMLHttpRequest();
        let url="http://localhost:8080/loanApplication/cancel";

        xmlhttp.open("POST",url);
        xmlhttp.setRequestHeader("content-type","application/json");

        xmlhttp.send(JSON.stringify(sendingData));
        xmlhttp.onload=function ()
        {
            let receivedData=JSON.parse(xmlhttp.responseText);

            console.log(receivedData);
        }
    }
    function logout()
        {
                localStorage.removeItem("userDetails");
                window.location.assign("ganesh-finance.html");
        }
 </script>
</html>
